import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:flutter_animate/flutter_animate.dart';
import '../../config/theme.dart';
import '../../models/video.dart';
import '../../providers/videos_provider.dart';
import '../../providers/radio_provider.dart';
import '../../widgets/bottom_navigation.dart';
import '../../widgets/mini_player.dart';
import '../../widgets/mesh_gradient_background.dart';
import '../../widgets/liquid_glass_container.dart';
import '../../widgets/screen_header.dart';
import 'widgets/video_card.dart';
import 'widgets/video_player_modal.dart';

/// Videos screen with grid of YouTube videos
class VideosScreen extends StatefulWidget {
  const VideosScreen({super.key});

  @override
  State<VideosScreen> createState() => _VideosScreenState();
}

class _VideosScreenState extends State<VideosScreen> {
  // Animation configuration constants
  static const _headerFadeDuration = Duration(milliseconds: 400);
  static const _searchBarFadeDuration = Duration(milliseconds: 500);
  static const _searchBarFadeDelay = Duration(milliseconds: 100);
  static const _cardFadeDuration = Duration(milliseconds: 400);
  static const _scaleBegin = Offset(0.95, 0.95);

  final TextEditingController _searchController = TextEditingController();

  @override
  void initState() {
    super.initState();
    _loadVideos();
  }

  Future<void> _loadVideos() async {
    final videosProvider = context.read<VideosProvider>();
    await videosProvider.fetchVideos();
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    // OPTIMIZED: Use select to rebuild only when specific properties change
    final videosProvider = context.watch<VideosProvider>();
    final showMiniPlayer = context.select<RadioProvider, bool>(
      (provider) => provider.isPlaying || provider.isPaused,
    );

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: MeshGradientBackground(
        child: SafeArea(
          bottom: false,
          child: Stack(
            children: [
              RefreshIndicator(
                onRefresh: () => videosProvider.refresh(),
                child: CustomScrollView(
                  slivers: [
                    // Header with back button
                    SliverToBoxAdapter(
                      child: ScreenHeader.withBack(
                        context: context,
                        title: 'VIDÉOS',
                        subtitle: 'DÉCOUVREZ',
                      ).animate().fadeIn(duration: _headerFadeDuration),
                    ),

                    const SliverToBoxAdapter(child: SizedBox(height: 20)),

                    // Search bar
                    SliverToBoxAdapter(
                      child: _buildSearchBar(videosProvider)
                          .animate()
                          .fadeIn(
                            duration: _searchBarFadeDuration,
                            delay: _searchBarFadeDelay,
                          )
                          .slideY(begin: 0.1, end: 0),
                    ),

                    const SliverToBoxAdapter(child: SizedBox(height: 16)),

                    // Results count
                    SliverToBoxAdapter(
                      child: _buildResultsCount(videosProvider),
                    ),

                    const SliverToBoxAdapter(child: SizedBox(height: 16)),

                    // Video grid or loading/error state
                    if (videosProvider.isLoading)
                      _buildLoadingGrid()
                    else if (videosProvider.error != null)
                      SliverToBoxAdapter(
                        child: _buildError(videosProvider.error!),
                      )
                    else if (videosProvider.filteredVideos.isEmpty)
                      SliverToBoxAdapter(child: _buildEmptyState())
                    else
                      _buildVideoGrid(videosProvider),

                    // Pagination
                    if (videosProvider.totalPages > 1)
                      SliverToBoxAdapter(
                        child: _buildPagination(videosProvider),
                      ),

                    // Bottom padding for mini player
                    SliverToBoxAdapter(
                      child: SizedBox(height: showMiniPlayer ? 100 : 20),
                    ),
                  ],
                ),
              ),

              // Mini Player
              Positioned(
                left: 0,
                right: 0,
                bottom: 0,
                child: MiniPlayer(visible: showMiniPlayer),
              ),
            ],
          ),
        ),
      ),
      bottomNavigationBar: const AppBottomNavigation(currentIndex: 2),
    );
  }

  Widget _buildSearchBar(VideosProvider videosProvider) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24),
      child: Container(
        // PERFORMANCE: Removed BackdropFilter, using static glass color
        decoration: BoxDecoration(
          color: AppColors.glassBackground,
          border: Border.all(color: AppColors.glassBorder, width: 1),
          borderRadius: BorderRadius.circular(GlassEffects.radiusMedium),
        ),
        child: TextField(
          controller: _searchController,
          style: const TextStyle(color: Colors.white),
          decoration: InputDecoration(
            hintText: 'Rechercher une vidéo...',
            hintStyle: TextStyle(
              color: Colors.white.withOpacity(0.5),
              fontSize: 14,
            ),
            prefixIcon: Icon(
              Icons.search,
              color: Colors.white.withOpacity(0.7),
            ),
            suffixIcon: _searchController.text.isNotEmpty
                ? IconButton(
                    icon: Icon(
                      Icons.clear,
                      color: Colors.white.withOpacity(0.7),
                    ),
                    onPressed: () {
                      _searchController.clear();
                      videosProvider.clearSearch();
                    },
                  )
                : null,
            border: InputBorder.none,
            contentPadding: const EdgeInsets.symmetric(
              horizontal: 16,
              vertical: 16,
            ),
          ),
          onChanged: (value) => videosProvider.search(value),
        ),
      ),
    );
  }

  Widget _buildResultsCount(VideosProvider videosProvider) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24),
      child: Text(
        '${videosProvider.totalVideos} vidéo${videosProvider.totalVideos > 1 ? 's' : ''} trouvée${videosProvider.totalVideos > 1 ? 's' : ''}',
        style: TextStyle(
          fontSize: 12,
          color: Colors.white.withOpacity(0.6),
          letterSpacing: 0.5,
        ),
      ),
    );
  }

  Widget _buildVideoGrid(VideosProvider videosProvider) {
    return SliverPadding(
      padding: const EdgeInsets.symmetric(horizontal: 24),
      sliver: SliverGrid(
        gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: 2,
          childAspectRatio: 0.7,
          crossAxisSpacing: 16,
          mainAxisSpacing: 16,
        ),
        delegate: SliverChildBuilderDelegate((context, index) {
          final video = videosProvider.currentPageVideos[index];

          return RepaintBoundary(
            child:
                VideoCard(
                      video: video,
                      onTap: () => VideoPlayerBottomSheet.show(context, video),
                    )
                    .animate()
                    .fadeIn(duration: _cardFadeDuration)
                    .scale(begin: _scaleBegin),
          );
        }, childCount: videosProvider.currentPageVideos.length),
      ),
    );
  }

  Widget _buildLoadingGrid() {
    return SliverPadding(
      padding: const EdgeInsets.symmetric(horizontal: 24),
      sliver: SliverGrid(
        gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: 2,
          childAspectRatio: 0.7,
          crossAxisSpacing: 16,
          mainAxisSpacing: 16,
        ),
        delegate: SliverChildBuilderDelegate(
          (context, index) => const VideoCardShimmer(),
          childCount: 6,
        ),
      ),
    );
  }

  Widget _buildError(String error) {
    return Padding(
      padding: const EdgeInsets.all(40),
      child: LiquidGlassContainer(
        padding: const EdgeInsets.all(32),
        showInnerGlow: true,
        child: Column(
          children: [
            Icon(
              Icons.error_outline,
              size: 64,
              color: AppColors.error.withOpacity(0.8),
            ),
            const SizedBox(height: 16),
            const Text(
              'Erreur de chargement',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.w600,
                color: Colors.white,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              error,
              style: TextStyle(
                fontSize: 14,
                color: Colors.white.withOpacity(0.7),
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),
            GestureDetector(
              onTap: _loadVideos,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 24,
                  vertical: 12,
                ),
                decoration: BoxDecoration(
                  gradient: AppColors.violetGradient,
                  borderRadius: BorderRadius.circular(GlassEffects.radiusSmall),
                  border: Border.all(
                    color: Colors.white.withOpacity(0.2),
                    width: 1,
                  ),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    const Icon(Icons.refresh, color: Colors.white, size: 20),
                    const SizedBox(width: 8),
                    const Text(
                      'Réessayer',
                      style: TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEmptyState() {
    return Padding(
      padding: const EdgeInsets.all(40),
      child: LiquidGlassContainer(
        padding: const EdgeInsets.all(32),
        showInnerGlow: true,
        child: Column(
          children: [
            Icon(
              Icons.video_library_outlined,
              size: 64,
              color: Colors.white.withOpacity(0.5),
            ),
            const SizedBox(height: 16),
            const Text(
              'Aucune vidéo trouvée',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.w600,
                color: Colors.white,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              'Essayez de modifier votre recherche',
              style: TextStyle(
                fontSize: 14,
                color: Colors.white.withOpacity(0.7),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildPagination(VideosProvider videosProvider) {
    return Padding(
      padding: const EdgeInsets.all(24),
      child: LiquidGlassContainer(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          mainAxisSize: MainAxisSize.min,
          children: [
            LiquidControlContainer(
              size: 36,
              onTap: videosProvider.currentPage > 1
                  ? () => videosProvider.previousPage()
                  : null,
              child: Icon(
                Icons.chevron_left,
                color: videosProvider.currentPage > 1
                    ? Colors.white
                    : Colors.white.withOpacity(0.3),
                size: 20,
              ),
            ),
            const SizedBox(width: 16),
            ...List.generate(
              videosProvider.totalPages.clamp(0, 5), // Limit to 5 pages shown
              (index) {
                final page = index + 1;
                return _buildPageButton(page, videosProvider);
              },
            ),
            const SizedBox(width: 16),
            LiquidControlContainer(
              size: 36,
              onTap: videosProvider.currentPage < videosProvider.totalPages
                  ? () => videosProvider.nextPage()
                  : null,
              child: Icon(
                Icons.chevron_right,
                color: videosProvider.currentPage < videosProvider.totalPages
                    ? Colors.white
                    : Colors.white.withOpacity(0.3),
                size: 20,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildPageButton(int page, VideosProvider videosProvider) {
    final isActive = page == videosProvider.currentPage;

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 4),
      child: GestureDetector(
        onTap: () => videosProvider.goToPage(page),
        child: Container(
          width: 36,
          height: 36,
          decoration: BoxDecoration(
            gradient: isActive ? AppColors.violetGradient : null,
            color: isActive ? null : Colors.white.withOpacity(0.1),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(
              color: isActive
                  ? Colors.white.withOpacity(0.3)
                  : Colors.white.withOpacity(0.15),
              width: 1,
            ),
          ),
          child: Center(
            child: Text(
              '$page',
              style: TextStyle(
                color: Colors.white,
                fontWeight: isActive ? FontWeight.bold : FontWeight.normal,
                fontSize: 14,
              ),
            ),
          ),
        ),
      ),
    );
  }
}
